{% extends 'base.html' %}

{% block title %}Controle de Frota{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark"><i class="fas fa-truck-pickup text-primary mr-2"></i>Controle de Frota</h1>
                <p class="text-muted mt-2">
                    <i class="fas fa-info-circle mr-1"></i> 
                    Gerenciamento completo de veículos, manutenções e registros da frota
                </p>
            </div>
            <div class="col-sm-6">
                <div class="float-sm-right mt-2">
                    {% if current_user.role.value in ['admin', 'gerente'] %}
                    <div class="btn-group">
                        <a href="{{ url_for('fleet') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-home mr-1"></i> Visão Geral
                        </a>
                        <a href="{{ url_for('new_vehicle') }}" class="btn btn-primary">
                            <i class="fas fa-plus-circle mr-1"></i> Novo Veículo
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <!-- Estatísticas da Frota - Layout Moderno -->
        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="card card-dashboard mb-4 bg-white shadow-sm border-0">
                    <div class="card-body position-relative overflow-hidden p-4">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h2 class="mb-1 font-weight-bold text-success counter">{{ stats.active }}</h2>
                                <p class="mb-0 text-muted">Veículos Ativos</p>
                                <div class="mt-3">
                                    <a href="{{ url_for('fleet', status='ativo') }}" class="btn btn-sm btn-outline-success rounded-pill px-3">
                                        <i class="fas fa-eye mr-1"></i> Ver Ativos
                                    </a>
                                </div>
                            </div>
                            <div class="stat-icon d-flex align-items-center justify-content-center">
                                <div class="rounded-circle bg-success-light p-3">
                                    <i class="fas fa-truck-moving fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                        <div class="progress progress-sm mt-3">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ (stats.active / stats.total * 100) if stats.total > 0 else 0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="card card-dashboard mb-4 bg-white shadow-sm border-0">
                    <div class="card-body position-relative overflow-hidden p-4">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h2 class="mb-1 font-weight-bold text-warning counter">{{ stats.maintenance }}</h2>
                                <p class="mb-0 text-muted">Em Manutenção</p>
                                <div class="mt-3">
                                    <a href="{{ url_for('fleet', status='em_manutencao') }}" class="btn btn-sm btn-outline-warning rounded-pill px-3">
                                        <i class="fas fa-tools mr-1"></i> Ver Manutenções
                                    </a>
                                </div>
                            </div>
                            <div class="stat-icon d-flex align-items-center justify-content-center">
                                <div class="rounded-circle bg-warning-light p-3">
                                    <i class="fas fa-tools fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                        <div class="progress progress-sm mt-3">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (stats.maintenance / stats.total * 100) if stats.total > 0 else 0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="card card-dashboard mb-4 bg-white shadow-sm border-0">
                    <div class="card-body position-relative overflow-hidden p-4">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h2 class="mb-1 font-weight-bold text-primary counter">{{ stats.total }}</h2>
                                <p class="mb-0 text-muted">Total da Frota</p>
                                <div class="mt-3">
                                    <a href="{{ url_for('fleet') }}" class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                        <i class="fas fa-list mr-1"></i> Ver Todos
                                    </a>
                                </div>
                            </div>
                            <div class="stat-icon d-flex align-items-center justify-content-center">
                                <div class="rounded-circle bg-primary-light p-3">
                                    <i class="fas fa-car-alt fa-2x text-primary"></i>
                                </div>
                            </div>
                        </div>
                        <div class="progress progress-sm mt-3">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="card card-dashboard mb-4 bg-white shadow-sm border-0">
                    <div class="card-body position-relative overflow-hidden p-4">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h2 class="mb-1 font-weight-bold text-danger counter">{{ stats.inactive }}</h2>
                                <p class="mb-0 text-muted">Veículos Inativos</p>
                                <div class="mt-3">
                                    <a href="{{ url_for('fleet', status='inativo') }}" class="btn btn-sm btn-outline-danger rounded-pill px-3">
                                        <i class="fas fa-ban mr-1"></i> Ver Inativos
                                    </a>
                                </div>
                            </div>
                            <div class="stat-icon d-flex align-items-center justify-content-center">
                                <div class="rounded-circle bg-danger-light p-3">
                                    <i class="fas fa-car-crash fa-2x text-danger"></i>
                                </div>
                            </div>
                        </div>
                        <div class="progress progress-sm mt-3">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ (stats.inactive / stats.total * 100) if stats.total > 0 else 0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            .bg-success-light { background-color: rgba(40, 167, 69, 0.15); }
            .bg-warning-light { background-color: rgba(255, 193, 7, 0.15); }
            .bg-primary-light { background-color: rgba(0, 123, 255, 0.15); }
            .bg-danger-light { background-color: rgba(220, 53, 69, 0.15); }
            
            .card-dashboard {
                transition: all 0.3s ease;
                border-radius: 10px;
            }
            
            .card-dashboard:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
            }
            
            .stat-icon {
                position: relative;
                z-index: 1;
            }
            
            .counter {
                font-size: 2.2rem;
            }
            
            .progress {
                height: 5px;
                border-radius: 10px;
            }
            
            .rounded-pill {
                border-radius: 50rem!important;
            }
        </style>

        <!-- Filtros - Design Moderno -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-bottom-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-search mr-2"></i>Busca e Filtros Avançados
                    </h5>
                    <button type="button" class="btn btn-link text-primary" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body pb-4">
                <form method="get" action="{{ url_for('fleet') }}" class="filter-form">
                    <div class="row">
                        <div class="col-xl-4 col-md-6">
                            <div class="form-group">
                                <div class="input-group input-group-lg">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text bg-white border-right-0">
                                            <i class="fas fa-search text-primary"></i>
                                        </span>
                                    </div>
                                    <input type="text" name="busca" id="search" class="form-control form-control-lg border-left-0" 
                                           placeholder="Placa, marca, modelo, chassi..." 
                                           value="{{ request.args.get('busca', '') }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-md-6">
                            <div class="form-group">
                                <select name="status" id="status" class="form-control custom-select form-control-lg select2">
                                    <option value="">Todos os Status</option>
                                    <option value="ativo" {% if request.args.get('status') == 'ativo' %}selected{% endif %}>
                                        <i class="fas fa-check text-success"></i> Ativo
                                    </option>
                                    <option value="em_manutencao" {% if request.args.get('status') == 'em_manutencao' %}selected{% endif %}>
                                        <i class="fas fa-tools text-warning"></i> Em Manutenção
                                    </option>
                                    <option value="inativo" {% if request.args.get('status') == 'inativo' %}selected{% endif %}>
                                        <i class="fas fa-ban text-danger"></i> Inativo
                                    </option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-md-6">
                            <div class="form-group">
                                <select name="fuel_type" id="fuel_type" class="form-control custom-select form-control-lg select2">
                                    <option value="">Todos os Combustíveis</option>
                                    <option value="gasolina" {% if request.args.get('fuel_type') == 'gasolina' %}selected{% endif %}>
                                        <i class="fas fa-gas-pump"></i> Gasolina
                                    </option>
                                    <option value="diesel" {% if request.args.get('fuel_type') == 'diesel' %}selected{% endif %}>
                                        <i class="fas fa-truck"></i> Diesel
                                    </option>
                                    <option value="alcool" {% if request.args.get('fuel_type') == 'alcool' %}selected{% endif %}>
                                        <i class="fas fa-tint"></i> Álcool
                                    </option>
                                    <option value="flex" {% if request.args.get('fuel_type') == 'flex' %}selected{% endif %}>
                                        <i class="fas fa-sync-alt"></i> Flex
                                    </option>
                                    <option value="gnv" {% if request.args.get('fuel_type') == 'gnv' %}selected{% endif %}>
                                        <i class="fas fa-atom"></i> GNV
                                    </option>
                                    <option value="eletrico" {% if request.args.get('fuel_type') == 'eletrico' %}selected{% endif %}>
                                        <i class="fas fa-bolt"></i> Elétrico
                                    </option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-xl-2 col-md-6">
                            <div class="d-flex">
                                <button type="submit" class="btn btn-primary btn-lg flex-grow-1 mr-2">
                                    <i class="fas fa-filter mr-2"></i>Filtrar
                                </button>
                                <a href="{{ url_for('fleet') }}" class="btn btn-light btn-lg px-3" title="Limpar Filtros">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtros avançados - collapse -->
                    <div class="mt-3">
                        <a class="btn btn-link text-muted p-0" data-toggle="collapse" href="#advancedFilters" role="button">
                            <i class="fas fa-sliders-h mr-1"></i> Filtros Avançados
                        </a>
                    </div>
                    
                    <div class="collapse mt-3" id="advancedFilters">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small">Data de Aquisição</label>
                                    <input type="date" name="acquisition_date" class="form-control" 
                                           value="{{ request.args.get('acquisition_date', '') }}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small">Responsável</label>
                                    <select name="responsible" class="form-control select2">
                                        <option value="">Todos os Responsáveis</option>
                                        <!-- Opções de responsáveis aqui -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small">Próxima Manutenção</label>
                                    <select name="maintenance_due" class="form-control">
                                        <option value="">Todas</option>
                                        <option value="late">Atrasadas</option>
                                        <option value="next7">Próximos 7 dias</option>
                                        <option value="next30">Próximos 30 dias</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small">Ordenar Por</label>
                                    <select name="sort" class="form-control">
                                        <option value="id_desc">Mais recentes</option>
                                        <option value="id_asc">Mais antigos</option>
                                        <option value="plate">Placa (A-Z)</option>
                                        <option value="brand">Marca (A-Z)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
            
        <style>
            /* Backgrounds coloridos claros */
            .bg-success-light {
                background-color: rgba(40, 167, 69, 0.15);
            }
            
            .bg-warning-light {
                background-color: rgba(255, 193, 7, 0.15);
            }
            
            .bg-danger-light {
                background-color: rgba(220, 53, 69, 0.15);
            }
            
            .bg-primary-light {
                background-color: rgba(0, 123, 255, 0.15);
            }
            
            .bg-info-light {
                background-color: rgba(23, 162, 184, 0.15);
            }
            
            .filter-form .form-control,
            .filter-form .input-group-text,
            .filter-form .btn {
                border-radius: 8px;
            }
            
            .filter-form .input-group-text {
                border-top-right-radius: 0;
                border-bottom-right-radius: 0;
            }
            
            .filter-form input.border-left-0 {
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
            }
            
            .select2-container--default .select2-selection--single {
                height: calc(1.5em + 1rem + 2px);
                padding: 0.5rem 1rem;
                border-radius: 8px;
                border: 1px solid #ced4da;
            }
            
            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: calc(1.5em + 1rem + 2px);
            }
        </style>

        <!-- Últimas Movimentações da Frota -->
        {% if latest_records and latest_records|length > 0 %}
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-bottom py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history text-info mr-2"></i>Últimas Movimentações
                    </h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-light rounded-circle" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="bg-light text-dark">Data</th>
                                <th class="bg-light text-dark">Veículo</th>
                                <th class="bg-light text-dark">Tipo</th>
                                <th class="bg-light text-dark">Descrição</th>
                                <th class="bg-light text-dark text-right">Custo</th>
                                <th class="bg-light text-dark text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in latest_records %}
                            <tr>
                                <td>{{ record.date.strftime('%d/%m/%Y') if record.date }}</td>
                                <td>
                                    <a href="{{ url_for('view_vehicle', id=record.vehicle.id) }}" class="text-primary">
                                        {{ record.vehicle.plate }}
                                    </a>
                                </td>
                                <td>
                                    {% if record.record_type == 'maintenance' %}
                                    <span class="badge badge-info">
                                        <i class="fas fa-tools mr-1"></i> Manutenção
                                    </span>
                                    {% else %}
                                    <span class="badge badge-success">
                                        <i class="fas fa-gas-pump mr-1"></i> Abastecimento
                                    </span>
                                    {% endif %}
                                </td>
                                <td>{{ record.description }}</td>
                                <td class="text-right">R$ {{ "%.2f"|format(record.cost|float) }}</td>
                                <td class="text-center">
                                    {% if record.record_type == 'maintenance' %}
                                    <a href="{{ url_for('vehicle_maintenance_history', vehicle_id=record.vehicle.id) }}" 
                                       class="btn btn-sm btn-outline-info rounded-circle">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% else %}
                                    <a href="{{ url_for('vehicle_maintenance_history', vehicle_id=record.vehicle.id) }}" 
                                       class="btn btn-sm btn-outline-success rounded-circle">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Lista de Veículos - Design Moderno -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-bottom py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-truck-pickup text-primary mr-2"></i>Veículos da Frota
                    </h5>
                    <div>
                        <a href="{{ url_for('new_vehicle') }}" class="btn btn-sm btn-primary rounded-pill px-3">
                            <i class="fas fa-plus-circle mr-1"></i> Novo Veículo
                        </a>
                        <button type="button" class="btn btn-sm btn-light rounded-circle ml-2" data-card-widget="maximize">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                {% if vehicles and vehicles.items|length > 0 %}
                <div class="table-responsive vehicle-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="bg-light text-dark">Veículo</th>
                                <th class="bg-light text-dark">Detalhes</th>
                                <th class="bg-light text-dark">Status</th>
                                <th class="bg-light text-dark">Manutenção</th>
                                <th class="bg-light text-dark">Responsável</th>
                                <th class="bg-light text-dark text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vehicle in vehicles.items %}
                            <tr class="vehicle-row">
                                <td style="min-width: 180px">
                                    <div class="d-flex align-items-center">
                                        <div class="vehicle-icon bg-{{ 
                                            'success-light' if vehicle.status.name == 'ativo' else 
                                            'warning-light' if vehicle.status.name == 'em_manutencao' else 
                                            'danger-light' }} rounded mr-3">
                                            {% if vehicle.image %}
                                                <img src="{{ url_for('static', filename='uploads/vehicles/' + vehicle.image) }}" 
                                                     alt="{{ vehicle.brand }} {{ vehicle.model }}" 
                                                     class="vehicle-thumbnail">
                                            {% else %}
                                                <i class="fas fa-{{ 
                                                    'truck' if vehicle.fuel_type and vehicle.fuel_type.value == 'diesel' else 
                                                    'car' if vehicle.fuel_type and vehicle.fuel_type.value in ['gasolina', 'flex', 'alcool'] else
                                                    'bolt' if vehicle.fuel_type and vehicle.fuel_type.value == 'eletrico' else
                                                    'car-side' }} fa-lg text-{{ 
                                                        'success' if vehicle.status.name == 'ativo' else 
                                                        'warning' if vehicle.status.name == 'em_manutencao' else 
                                                        'danger' }}"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ vehicle.brand }} {{ vehicle.model }}</h6>
                                            <span class="badge badge-pill badge-light">
                                                {{ vehicle.year if vehicle.year else 'Ano N/D' }}
                                            </span>
                                            {% if vehicle.plate %}
                                                <span class="badge badge-pill badge-primary mt-1 d-inline-block">
                                                    {{ vehicle.plate }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                
                                <td>
                                    <div class="vehicle-details">
                                        <div>
                                            <small class="text-muted">Placa:</small>
                                            <span class="badge badge-pill badge-secondary">{{ vehicle.plate }}</span>
                                        </div>
                                        {% if vehicle.fuel_type %}
                                        <div class="mt-1">
                                            <small class="text-muted">Combustível:</small>
                                            <span class="badge badge-pill badge-info">{{ vehicle.fuel_type.value }}</span>
                                        </div>
                                        {% endif %}
                                        {% if vehicle.mileage is not none %}
                                        <div class="mt-1">
                                            <small class="text-muted">Hodômetro:</small>
                                            <strong>{{ "{:,}".format(vehicle.mileage).replace(',', '.') }}</strong> km
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                                
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator bg-{{ 
                                            'success' if vehicle.status.name == 'ativo' else 
                                            'warning' if vehicle.status.name == 'em_manutencao' else 
                                            'danger' }}"></div>
                                        <div class="ml-2">
                                            <span class="status-text text-{{ 
                                                'success' if vehicle.status.name == 'ativo' else 
                                                'warning' if vehicle.status.name == 'em_manutencao' else 
                                                'danger' }}">
                                                {{ vehicle.status.value }}
                                            </span>
                                            {% if vehicle.status.name == 'em_manutencao' %}
                                                <div class="text-muted small">
                                                    <i class="fas fa-tools fa-sm"></i> Em serviço
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                
                                <td>
                                    {% if vehicle.next_maintenance_date %}
                                        <div class="d-flex align-items-center">
                                            <div class="mr-2">
                                                {% if vehicle.next_maintenance_date <= today %}
                                                    <span class="badge badge-pill badge-danger">
                                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                                        Atrasada
                                                    </span>
                                                {% elif (vehicle.next_maintenance_date - today).days <= 7 %}
                                                    <span class="badge badge-pill badge-warning">
                                                        <i class="fas fa-clock mr-1"></i>
                                                        Em breve
                                                    </span>
                                                {% else %}
                                                    <span class="badge badge-pill badge-success">
                                                        <i class="fas fa-check mr-1"></i>
                                                        Em dia
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div>
                                                {{ vehicle.next_maintenance_date.strftime('%d/%m/%Y') }}
                                                {% if vehicle.next_maintenance_km %}
                                                <div class="text-muted small">
                                                    ou {{ "{:,}".format(vehicle.next_maintenance_km).replace(',', '.') }} km
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-calendar-times mr-1"></i>
                                            Não programada
                                        </span>
                                    {% endif %}
                                </td>
                                
                                <td>
                                    {% if vehicle.responsible %}
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle bg-primary-light text-primary mr-2">
                                                {{ vehicle.responsible.name[:1].upper() }}
                                            </div>
                                            <div>
                                                {{ vehicle.responsible.name }}
                                                {% if vehicle.responsible.role %}
                                                <div class="text-muted small">{{ vehicle.responsible.role.value }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="text-muted">
                                            <i class="fas fa-user-slash mr-1"></i>
                                            Não definido
                                        </div>
                                    {% endif %}
                                </td>
                                
                                <td>
                                    <div class="d-flex justify-content-center">
                                        <a href="{{ url_for('view_vehicle', id=vehicle.id) }}" 
                                           class="btn btn-sm btn-outline-primary rounded-circle mr-1"
                                           data-toggle="tooltip" title="Visualizar detalhes">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        
                                        <!-- Todos os usuários agora podem acessar ações de edição -->
                                        <a href="{{ url_for('edit_vehicle', id=vehicle.id) }}" 
                                           class="btn btn-sm btn-outline-warning rounded-circle mr-1"
                                           data-toggle="tooltip" title="Editar veículo">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        
                                        <a href="{{ url_for('register_refueling', id=vehicle.id) }}" 
                                           class="btn btn-sm btn-outline-success rounded-circle mr-1"
                                           data-toggle="tooltip" title="Registrar abastecimento">
                                            <i class="fas fa-gas-pump"></i>
                                        </a>
                                        
                                        <a href="{{ url_for('new_vehicle_maintenance', id=vehicle.id) }}" 
                                           class="btn btn-sm btn-outline-info rounded-circle mr-1"
                                           data-toggle="tooltip" title="Registrar manutenção">
                                            <i class="fas fa-tools"></i>
                                        </a>
                                        
                                        {% if current_user.role.value == 'admin' %}
                                        <button type="button"
                                           class="btn btn-sm btn-outline-danger rounded-circle"
                                           data-toggle="modal" 
                                           data-target="#deleteVehicleModal{{ vehicle.id }}"
                                           title="Excluir veículo">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        
                                        <!-- Modal de confirmação para exclusão -->
                                        <div class="modal fade" id="deleteVehicleModal{{ vehicle.id }}" tabindex="-1" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-danger text-white">
                                                        <h5 class="modal-title">Confirmar Exclusão</h5>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p>Tem certeza que deseja excluir o veículo <strong>{{ vehicle.plate }}</strong>?</p>
                                                        <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Esta ação é irreversível. Todos os dados relacionados a este veículo, incluindo histórico de manutenções e abastecimentos, serão removidos.</p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                                        <form action="{{ url_for('excluir_veiculo_direct', id=vehicle.id) }}" method="POST">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                            <button type="submit" class="btn btn-danger">Excluir</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <div class="empty-state">
                        <div class="empty-state-icon bg-light rounded-circle mb-3">
                            <i class="fas fa-truck fa-2x text-muted"></i>
                        </div>
                        <h5>Nenhum veículo encontrado</h5>
                        <p class="text-muted">Não foram encontrados veículos com os filtros selecionados.</p>
                        <a href="{{ url_for('fleet') }}" class="btn btn-outline-primary rounded-pill px-4">
                            <i class="fas fa-sync-alt mr-1"></i> Limpar Filtros
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-12 col-md-5">
                        <div class="dataTables_info" role="status">
                            Mostrando {{ vehicles.items|length }} de {{ vehicles.total }} veículos
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-7">
                        <div class="dataTables_paginate paging_simple_numbers float-right">
                            {% if vehicles.pages > 1 %}
                            <ul class="pagination">
                                <li class="paginate_button page-item previous {% if not vehicles.has_prev %}disabled{% endif %}">
                                    <a href="{{ url_for('fleet', page=vehicles.prev_num, **request.args) if vehicles.has_prev else '#' }}" class="page-link">
                                        Anterior
                                    </a>
                                </li>
                                {% for page in vehicles.iter_pages() %}
                                    {% if page %}
                                        <li class="paginate_button page-item {% if page == vehicles.page %}active{% endif %}">
                                            <a href="{{ url_for('fleet', page=page, **request.args) }}" class="page-link">{{ page }}</a>
                                        </li>
                                    {% else %}
                                        <li class="paginate_button page-item disabled">
                                            <a href="#" class="page-link">...</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                <li class="paginate_button page-item next {% if not vehicles.has_next %}disabled{% endif %}">
                                    <a href="{{ url_for('fleet', page=vehicles.next_num, **request.args) if vehicles.has_next else '#' }}" class="page-link">
                                        Próximo
                                    </a>
                                </li>
                            </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Inicializar tooltips
    $(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });
    
    // Inicializar formulários de exclusão
    $(document).ready(function() {
        // Inicializar todos os botões e formulários de exclusão
        $('form[id^="deleteVehicleForm"]').each(function() {
            var formId = $(this).attr('id');
            console.log('Inicializando formulário de exclusão: ' + formId);
            
            $(this).on('submit', function(e) {
                console.log('Formulário de exclusão enviado: ' + formId);
                // Garantir que o formulário seja enviado corretamente
                return true;
            });
        });
    });
</script>
{% endblock %}