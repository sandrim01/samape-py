{% extends 'base.html' %}

{% block title %}Frota{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Gerenciamento de Frota</h1>
            </div>
            <div class="col-sm-6">
                <div class="float-sm-right">
                    {% if current_user.role.value in ['admin', 'gerente'] %}
                    <a href="{{ url_for('new_vehicle') }}" class="btn btn-primary">
                        <i class="fas fa-plus mr-1"></i> Novo Veículo
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <!-- Estatísticas da Frota -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ stats.active }}</h3>
                        <p>Veículos Ativos</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-truck"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ stats.maintenance }}</h3>
                        <p>Em Manutenção</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-tools"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ stats.reserved }}</h3>
                        <p>Reservados</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-bookmark"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ stats.inactive }}</h3>
                        <p>Inativos</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-ban"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Filtros</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form method="get" action="{{ url_for('fleet') }}">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select name="status" id="status" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="ativo" {% if request.args.get('status') == 'ativo' %}selected{% endif %}>Ativo</option>
                                    <option value="em_manutencao" {% if request.args.get('status') == 'em_manutencao' %}selected{% endif %}>Em Manutenção</option>
                                    <!-- Opção 'reservado' removida - não existe no banco de dados -->
                                    <option value="inativo" {% if request.args.get('status') == 'inativo' %}selected{% endif %}>Inativo</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="type">Tipo</label>
                                <select name="type" id="type" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="caminhao" {% if request.args.get('type') == 'caminhao' %}selected{% endif %}>Caminhão</option>
                                    <option value="carro" {% if request.args.get('type') == 'carro' %}selected{% endif %}>Carro</option>
                                    <option value="maquina" {% if request.args.get('type') == 'maquina' %}selected{% endif %}>Máquina</option>
                                    <option value="motocicleta" {% if request.args.get('type') == 'motocicleta' %}selected{% endif %}>Motocicleta</option>
                                    <option value="outro" {% if request.args.get('type') == 'outro' %}selected{% endif %}>Outro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="search">Buscar</label>
                                <input type="text" name="q" id="search" class="form-control" placeholder="Identificador, placa, marca..." value="{{ request.args.get('q', '') }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search mr-1"></i> Filtrar
                                    </button>
                                    <a href="{{ url_for('fleet') }}" class="btn btn-default">
                                        <i class="fas fa-times mr-1"></i> Limpar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de Veículos -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Veículos</h3>
            </div>
            <div class="card-body p-0">
                {% if vehicles %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th style="width: 10%">Identificador</th>
                                <th style="width: 15%">Marca/Modelo</th>
                                <th style="width: 10%">Tipo</th>
                                <th style="width: 10%">Placa</th>
                                <th style="width: 10%">Hodômetro</th>
                                <th style="width: 12%">Próxima Manutenção</th>
                                <th style="width: 10%">Status</th>
                                <th style="width: 13%">Responsável</th>
                                <th style="width: 10%">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vehicle in vehicles %}
                            <tr>
                                <td>{{ vehicle.identifier }}</td>
                                <td>{{ vehicle.brand }} {{ vehicle.model }}</td>
                                <td>{{ vehicle.fuel_type.value if vehicle.fuel_type else '-' }}</td>
                                <td>{{ vehicle.license_plate or '-' }}</td>
                                <td>{{ vehicle.mileage if vehicle.mileage is not none else '-' }}</td>
                                <td>
                                    {{ vehicle.next_maintenance_date.strftime('%d/%m/%Y') if vehicle.next_maintenance_date else '-' }}
                                    {% if vehicle.next_maintenance_date and vehicle.next_maintenance_date <= today %}
                                    <span class="badge badge-danger">Atrasada</span>
                                    {% elif vehicle.next_maintenance_date and (vehicle.next_maintenance_date - today).days <= 7 %}
                                    <span class="badge badge-warning">Próxima</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-{{ 
                                        'success' if vehicle.status.name == 'ativo' else 
                                        'warning' if vehicle.status.name == 'em_manutencao' else 
                                        'secondary' }}">
                                        {{ vehicle.status.value }}
                                    </span>
                                </td>
                                <td>{{ vehicle.responsible.name if vehicle.responsible else 'Não definido' }}</td>
                                <td>
                                    <a href="{{ url_for('view_vehicle', id=vehicle.id) }}" class="btn btn-sm btn-info mr-1">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if current_user.role.value in ['admin', 'gerente'] %}
                                    <a href="{{ url_for('edit_vehicle', id=vehicle.id) }}" class="btn btn-sm btn-warning">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-truck fa-4x text-muted mb-3"></i>
                    <p class="text-muted">Nenhum veículo encontrado com os filtros selecionados.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-12 col-md-5">
                        <div class="dataTables_info" role="status">
                            Mostrando {{ vehicles.items|length }} de {{ vehicles.total }} veículos
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-7">
                        <div class="dataTables_paginate paging_simple_numbers float-right">
                            {% if pagination.pages > 1 %}
                            <ul class="pagination">
                                <li class="paginate_button page-item previous {% if not pagination.has_prev %}disabled{% endif %}">
                                    <a href="{{ url_for('fleet', page=pagination.prev_num, **request.args) if pagination.has_prev else '#' }}" class="page-link">
                                        Anterior
                                    </a>
                                </li>
                                {% for page in pagination.iter_pages() %}
                                    {% if page %}
                                        <li class="paginate_button page-item {% if page == pagination.page %}active{% endif %}">
                                            <a href="{{ url_for('fleet', page=page, **request.args) }}" class="page-link">{{ page }}</a>
                                        </li>
                                    {% else %}
                                        <li class="paginate_button page-item disabled">
                                            <a href="#" class="page-link">...</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                <li class="paginate_button page-item next {% if not pagination.has_next %}disabled{% endif %}">
                                    <a href="{{ url_for('fleet', page=pagination.next_num, **request.args) if pagination.has_next else '#' }}" class="page-link">
                                        Próximo
                                    </a>
                                </li>
                            </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}