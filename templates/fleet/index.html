{% extends 'base.html' %}

{% block title %}Frota{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0"><i class="fas fa-truck-pickup mr-2"></i>Gerenciamento de Frota</h1>
            </div>
            <div class="col-sm-6">
                <div class="float-sm-right">
                    {% if current_user.role.value in ['admin', 'gerente'] %}
                    <a href="{{ url_for('new_vehicle') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus mr-1"></i> Adicionar Novo Veículo
                    </a>
                    <a href="{{ url_for('vehicle_maintenance_history') }}" class="btn btn-info btn-lg ml-2">
                        <i class="fas fa-wrench mr-1"></i> Histórico de Manutenções
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <!-- Estatísticas da Frota -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-gradient-success">
                    <div class="inner">
                        <h3>{{ stats.active }}</h3>
                        <p>Veículos Ativos</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <a href="{{ url_for('fleet', status='ativo') }}" class="small-box-footer">
                        Ver detalhes <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-gradient-warning">
                    <div class="inner">
                        <h3>{{ stats.maintenance }}</h3>
                        <p>Em Manutenção</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <a href="{{ url_for('fleet', status='em_manutencao') }}" class="small-box-footer">
                        Ver detalhes <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-gradient-primary">
                    <div class="inner">
                        <h3>{{ stats.total }}</h3>
                        <p>Total de Veículos</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-car-alt"></i>
                    </div>
                    <a href="{{ url_for('fleet') }}" class="small-box-footer">
                        Ver todos <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-gradient-danger">
                    <div class="inner">
                        <h3>{{ stats.inactive }}</h3>
                        <p>Inativos</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-ban"></i>
                    </div>
                    <a href="{{ url_for('fleet', status='inativo') }}" class="small-box-footer">
                        Ver detalhes <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-filter mr-2"></i>Filtros de Busca</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form method="get" action="{{ url_for('fleet') }}">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="status">Status do Veículo</label>
                                <select name="status" id="status" class="form-control select2">
                                    <option value="">Todos os Status</option>
                                    <option value="ativo" {% if request.args.get('status') == 'ativo' %}selected{% endif %}>
                                        <i class="fas fa-check text-success"></i> Ativo
                                    </option>
                                    <option value="em_manutencao" {% if request.args.get('status') == 'em_manutencao' %}selected{% endif %}>
                                        <i class="fas fa-tools text-warning"></i> Em Manutenção
                                    </option>
                                    <option value="inativo" {% if request.args.get('status') == 'inativo' %}selected{% endif %}>
                                        <i class="fas fa-ban text-danger"></i> Inativo
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="fuel_type">Tipo de Combustível</label>
                                <select name="fuel_type" id="fuel_type" class="form-control select2">
                                    <option value="">Todos os Tipos</option>
                                    <option value="gasolina" {% if request.args.get('fuel_type') == 'gasolina' %}selected{% endif %}>Gasolina</option>
                                    <option value="diesel" {% if request.args.get('fuel_type') == 'diesel' %}selected{% endif %}>Diesel</option>
                                    <option value="alcool" {% if request.args.get('fuel_type') == 'alcool' %}selected{% endif %}>Álcool</option>
                                    <option value="flex" {% if request.args.get('fuel_type') == 'flex' %}selected{% endif %}>Flex</option>
                                    <option value="gnv" {% if request.args.get('fuel_type') == 'gnv' %}selected{% endif %}>GNV</option>
                                    <option value="eletrico" {% if request.args.get('fuel_type') == 'eletrico' %}selected{% endif %}>Elétrico</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="search">Buscar</label>
                                <div class="input-group">
                                    <input type="text" name="busca" id="search" class="form-control" 
                                           placeholder="Placa, marca, modelo, chassi..." 
                                           value="{{ request.args.get('busca', '') }}">
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div>
                                    <a href="{{ url_for('fleet') }}" class="btn btn-secondary btn-block">
                                        <i class="fas fa-undo mr-1"></i> Limpar Filtros
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de Veículos -->
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-car-side mr-2"></i>Lista de Veículos</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="maximize">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                {% if vehicles and vehicles.items|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th style="width: 8%">Identificador</th>
                                <th style="width: 15%">Marca/Modelo</th>
                                <th style="width: 10%">Combustível</th>
                                <th style="width: 10%">Placa</th>
                                <th style="width: 10%">Hodômetro</th>
                                <th style="width: 12%">Próxima Manutenção</th>
                                <th style="width: 10%">Status</th>
                                <th style="width: 13%">Responsável</th>
                                <th style="width: 12%">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vehicle in vehicles.items %}
                            <tr>
                                <td>
                                    <span class="badge badge-secondary">{{ vehicle.identifier }}</span>
                                </td>
                                <td>
                                    <strong>{{ vehicle.brand }}</strong><br>
                                    <small class="text-muted">{{ vehicle.model }} ({{ vehicle.year or 'N/A' }})</small>
                                </td>
                                <td>
                                    {% if vehicle.fuel_type %}
                                        <span class="badge badge-info">{{ vehicle.fuel_type.value }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">Não definido</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if vehicle.license_plate %}
                                        <span class="badge badge-primary">{{ vehicle.license_plate }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if vehicle.mileage is not none %}
                                        {{ "{:,}".format(vehicle.mileage).replace(',', '.') }} km
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if vehicle.next_maintenance_date %}
                                        {{ vehicle.next_maintenance_date.strftime('%d/%m/%Y') }}
                                        {% if vehicle.next_maintenance_date <= today %}
                                            <span class="badge badge-danger">Atrasada</span>
                                        {% elif (vehicle.next_maintenance_date - today).days <= 7 %}
                                            <span class="badge badge-warning">Próxima</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Não programada</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-{{ 
                                        'success' if vehicle.status.name == 'ativo' else 
                                        'warning' if vehicle.status.name == 'em_manutencao' else 
                                        'danger' }}">
                                        {{ vehicle.status.value }}
                                    </span>
                                </td>
                                <td>
                                    {% if vehicle.responsible %}
                                        <i class="fas fa-user mr-1"></i> {{ vehicle.responsible.name }}
                                    {% else %}
                                        <span class="text-muted"><i class="fas fa-user-slash mr-1"></i> Não definido</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{{ url_for('view_vehicle', id=vehicle.id) }}" class="btn btn-sm btn-info" 
                                           title="Visualizar detalhes">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if current_user.role.value in ['admin', 'gerente'] %}
                                        <a href="{{ url_for('edit_vehicle', id=vehicle.id) }}" class="btn btn-sm btn-warning" 
                                           title="Editar veículo">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('new_vehicle_maintenance', id=vehicle.id) }}" class="btn btn-sm btn-primary" 
                                           title="Registrar manutenção">
                                            <i class="fas fa-tools"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-truck fa-4x text-muted mb-3"></i>
                    <p class="text-muted">Nenhum veículo encontrado com os filtros selecionados.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-12 col-md-5">
                        <div class="dataTables_info" role="status">
                            Mostrando {{ vehicles.items|length }} de {{ vehicles.total }} veículos
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-7">
                        <div class="dataTables_paginate paging_simple_numbers float-right">
                            {% if vehicles.pages > 1 %}
                            <ul class="pagination">
                                <li class="paginate_button page-item previous {% if not vehicles.has_prev %}disabled{% endif %}">
                                    <a href="{{ url_for('fleet', page=vehicles.prev_num, **request.args) if vehicles.has_prev else '#' }}" class="page-link">
                                        Anterior
                                    </a>
                                </li>
                                {% for page in vehicles.iter_pages() %}
                                    {% if page %}
                                        <li class="paginate_button page-item {% if page == vehicles.page %}active{% endif %}">
                                            <a href="{{ url_for('fleet', page=page, **request.args) }}" class="page-link">{{ page }}</a>
                                        </li>
                                    {% else %}
                                        <li class="paginate_button page-item disabled">
                                            <a href="#" class="page-link">...</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                <li class="paginate_button page-item next {% if not vehicles.has_next %}disabled{% endif %}">
                                    <a href="{{ url_for('fleet', page=vehicles.next_num, **request.args) if vehicles.has_next else '#' }}" class="page-link">
                                        Próximo
                                    </a>
                                </li>
                            </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}