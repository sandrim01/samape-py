{% extends 'base.html' %}

{% block title %}Ordens de Serviço{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Ordens de Serviço</h2>
        <div>
            <a href="{{ url_for('new_service_order') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Nova OS
            </a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Filtros</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('os_lista') }}" method="get" id="searchForm">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">Todos</option>
                            <option value="aberta" {% if request.args.get('status') == 'aberta' %}selected{% endif %}>Aberta</option>
                            <option value="em_andamento" {% if request.args.get('status') == 'em_andamento' %}selected{% endif %}>Em andamento</option>
                            <option value="concluida" {% if request.args.get('status') == 'concluida' %}selected{% endif %}>Concluída</option>
                            <option value="fechada" {% if request.args.get('status') == 'fechada' %}selected{% endif %}>Fechada</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="client" class="form-label">Cliente</label>
                        <select class="form-select" id="client" name="client">
                            <option value="">Todos</option>
                            {% for client in clients %}
                            <option value="{{ client[0] }}" {% if request.args.get('client')|int == client[0] %}selected{% endif %}>{{ client[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="responsible" class="form-label">Responsável</label>
                        <select class="form-select" id="responsible" name="responsible">
                            <option value="">Todos</option>
                            {% for user in users %}
                            <option value="{{ user[0] }}" {% if request.args.get('responsible')|int == user[0] %}selected{% endif %}>{{ user[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="search" class="form-label">Busca</label>
                        <input type="text" class="form-control" id="search" name="search" placeholder="Número, descrição..." value="{{ request.args.get('search', '') }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Resultado</h5>
            <span class="text-muted">{{ service_orders|length }} ordens encontradas</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>OS #</th>
                            <th>Cliente</th>
                            <th>Equipamento</th>
                            <th>Serviço</th>
                            <th>Status</th>
                            <th>Abertura</th>
                            <th>Responsável</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in service_orders %}
                        <tr>
                            <td><strong>{{ order.id }}</strong></td>
                            <td>{{ order.client_name }}</td>
                            <td>
                                {% if order.equipment %}
                                    {{ order.equipment }}
                                {% else %}
                                    <span class="text-muted">Não definido</span>
                                {% endif %}
                            </td>
                            <td class="text-truncate" style="max-width: 200px;" title="{{ order.description }}">
                                {{ order.description }}
                            </td>
                            <td>
                                {% if order.status == 'aberta' %}
                                <span class="badge bg-info">Aberta</span>
                                {% elif order.status == 'em_andamento' %}
                                <span class="badge bg-warning">Em andamento</span>
                                {% elif order.status == 'concluida' %}
                                <span class="badge bg-success">Concluída</span>
                                {% elif order.status == 'fechada' %}
                                <span class="badge bg-secondary">Fechada</span>
                                {% else %}
                                <span class="badge bg-light text-dark">{{ order.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if order.created_at %}
                                    {{ order.created_at.strftime('%d/%m/%Y %H:%M') }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if order.responsible_name %}
                                    {{ order.responsible_name }}
                                {% else %}
                                    <span class="text-muted">Não atribuído</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary view-order" data-id="{{ order.id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="{{ url_for('view_service_order_basic', id=order.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-info-circle"></i>
                                    </a>
                                    <a href="{{ url_for('edit_service_order', id=order.id) }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if is_admin %}
                                    <a href="{{ url_for('delete_service_order', id=order.id) }}" class="btn btn-sm btn-outline-danger" 
                                       onclick="return confirm('Tem certeza que deseja excluir esta OS? Esta ação não pode ser desfeita.');">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-search fa-2x mb-3"></i>
                                    <p>Nenhuma ordem de serviço encontrada com os filtros selecionados.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Visualização Rápida -->
<div class="modal fade" id="viewOrderModal" tabindex="-1" aria-labelledby="viewOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewOrderModalLabel">Detalhes da Ordem de Serviço</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando detalhes da ordem de serviço...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <a href="#" class="btn btn-primary" id="fullDetailsLink">Ver Detalhes Completos</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manipuladores para os botões de visualização rápida
    const viewButtons = document.querySelectorAll('.view-order');
    const modal = new bootstrap.Modal(document.getElementById('viewOrderModal'));
    const modalContent = document.getElementById('modalContent');
    const fullDetailsLink = document.getElementById('fullDetailsLink');
    
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.getAttribute('data-id');
            
            // Atualizar link para detalhes completos
            fullDetailsLink.href = `/os_basico/${orderId}`;
            
            // Mostrar modal com spinner
            modal.show();
            
            // Carregar dados da OS via AJAX
            fetch(`/os_dados/${orderId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar dados da OS');
                    }
                    return response.json();
                })
                .then(data => {
                    // Montar o HTML com os dados da OS
                    const html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Informações Básicas</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <th>Número:</th>
                                        <td>#${data.id}</td>
                                    </tr>
                                    <tr>
                                        <th>Cliente:</th>
                                        <td>${data.client_name}</td>
                                    </tr>
                                    <tr>
                                        <th>Responsável:</th>
                                        <td>${data.responsible_name}</td>
                                    </tr>
                                    <tr>
                                        <th>Status:</th>
                                        <td><span class="badge ${getStatusBadgeClass(data.status)}">${getStatusLabel(data.status)}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Data Abertura:</th>
                                        <td>${data.created_at || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <th>Data Fechamento:</th>
                                        <td>${data.closed_at || 'Em aberto'}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Valores</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <th>Valor Original:</th>
                                        <td>R$ ${formatNumber(data.original_amount)}</td>
                                    </tr>
                                    <tr>
                                        <th>Desconto:</th>
                                        <td>R$ ${formatNumber(data.discount_amount)}</td>
                                    </tr>
                                    <tr>
                                        <th>Valor Total:</th>
                                        <td><strong>R$ ${formatNumber(data.total_value)}</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6>Descrição do Serviço</h6>
                                <p>${data.description || 'Nenhuma descrição disponível'}</p>
                            </div>
                        </div>
                    `;
                    
                    // Atualizar o conteúdo do modal
                    modalContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Erro:', error);
                    modalContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Erro ao carregar os dados. Por favor, tente novamente.
                        </div>
                    `;
                });
        });
    });
    
    // Funções auxiliares para formatação
    function getStatusBadgeClass(status) {
        const classes = {
            'aberta': 'bg-info',
            'em_andamento': 'bg-warning',
            'concluida': 'bg-success',
            'fechada': 'bg-secondary'
        };
        return classes[status] || 'bg-light text-dark';
    }
    
    function getStatusLabel(status) {
        const labels = {
            'aberta': 'Aberta',
            'em_andamento': 'Em andamento',
            'concluida': 'Concluída',
            'fechada': 'Fechada'
        };
        return labels[status] || status;
    }
    
    function formatNumber(value) {
        if (value === null || value === undefined) return '0,00';
        return parseFloat(value).toFixed(2).replace('.', ',');
    }
});
</script>
{% endblock %}